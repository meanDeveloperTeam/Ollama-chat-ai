<!-- ChatGPT-like UI with sidebar and chat area, now with dynamic streaming chat integration -->
<div class="container-fluid vh-100 d-flex flex-row p-0" style="height: 100vh;">
  <!-- Sidebar -->
  <div class="bg-light border-end h-100 overflow-hidden" [@sidebarCollapse]="sidebarState"
    style="will-change: width, min-width, opacity;">
    <div class="d-flex flex-column h-100 p-3" *ngIf="!sidebarCollapsed()">
      <h4 class="mb-4 d-flex align-items-center">
        <i class="bi bi-chat-left-text me-2"></i> Chats
      </h4>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item mb-2 position-relative" *ngFor="let chat of chats();  trackBy: trackByChatId" (click)="loadChat(chat._id)">
          <a href="#" class="nav-link d-flex align-items-center pe-4" [ngClass]="{'active' : chat._id === currentChatId()}">
            <i class="bi bi-robot me-2"></i> {{ chat.title || 'Untitled' }}
          </a>
          <i class="bi bi-trash text-danger position-absolute top-50 end-0 translate-middle-y me-2" title="Delete chat"
             (click)="deleteChat(chat._id); $event.stopPropagation()" style="cursor:pointer;"></i>
        </li>
        <li class="nav-item mb-2" (click)="createChat('New Chat')">
          <a href="#" class="nav-link d-flex align-items-center">
            <i class="bi bi-plus-circle me-2"></i> New Chat
          </a>
        </li>
      </ul>
      <div class="mt-auto">
        <button class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center">
          <i class="bi bi-gear me-2"></i> Settings
        </button>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-grow-1 d-flex flex-column position-relative bg-white">
    <!-- Sidebar Toggle Button -->
    <button class="btn btn-light position-absolute top-0 start-0 m-2 shadow-sm" style="z-index: 20;"
      (click)="toggleSidebar()" [ngClass]="{ 'ms-0': sidebarCollapsed(), 'ms-2': !sidebarCollapsed() }"
      title="Toggle sidebar">
      <i class="bi" [ngClass]="sidebarCollapsed() ? 'bi-list' : 'bi-chevron-left'"></i>
    </button>

    <!-- Chat Messages (dynamic) -->
    <div #chatContainer class="flex-grow-1 overflow-auto p-4" style="margin-bottom: 80px;">
      <div *ngFor="let msg of messages(); let i = index" class="mb-3 d-flex position-relative"
        [ngClass]="msg.role === 'user' ? 'justify-content-start' : 'justify-content-end'">

        <div [ngClass]="msg.role === 'user'
            ? 'bg-light border rounded p-3 me-auto'
            : 'bg-secondary text-white rounded p-3 ms-auto'" style="max-width: 60%; white-space: pre-wrap;">

          <!-- Message blocks rendering -->
          <ng-container *ngFor="let block of msg.blocks">
            <ng-container [ngSwitch]="block.type">

              <!-- Text block -->
              <span *ngSwitchCase="'text'">{{ block.content }}</span>

              <!-- Code block -->
              <pre *ngSwitchCase="'code'" class="bg-dark text-white p-2 rounded mt-2">
                <code>{{ block.content }}</code>
              </pre>

              <!-- Output block for assistant's code -->
              <div *ngIf="msg.role === 'assistant' && block.type === 'code'"
                class="bg-light border rounded p-2 mt-2 mb-2 text-dark">
                <strong>Output:</strong>
                <div class="mt-1" style="white-space: pre-wrap;">
                  Code executed successfully (mock output)
                </div>
              </div>

              <details *ngSwitchCase="'think'" open
              class="thinking-effect"
              style="font-family: 'JetBrains Mono', monospace;">
                <summary class="d-flex align-items-center">
                  <i class="bi bi-lightbulb-fill text-warning me-2"></i>
                  <span>Thoughts</span>
                  <div class="dots-bounce ms-2">
                    <span></span><span></span><span></span>
                  </div>
                </summary>
                <div class="mt-2" style="white-space: pre-wrap;">{{ block.content }}</div>
              </details>

            </ng-container>
          </ng-container>
        </div>
        <i class="bi bi-x-circle-fill text-danger position-absolute top-0 end-0 translate-middle"
           title="Delete message" style="cursor:pointer; font-size: 0.9rem;"
           (click)="deleteMessage(i); $event.stopPropagation()"></i>
      </div>
    </div>

    <!-- Chat Input (fixed at bottom) -->
    <form class="position-absolute bottom-0 start-0 w-100 bg-white border-top p-3" style="z-index: 10;"
      (submit)="onSendMessage($event, chatInput.value); chatInput.value = '';">

      <div class="input-group">
        <textarea #chatInput class="form-control" placeholder="Type your message..." rows="1"
          style="resize: none; overflow-y: auto;"></textarea>
        <button class="btn btn-primary d-flex align-items-center" type="submit">
          <span class="me-1">Send</span>
          <i class="bi bi-send"></i>
        </button>
      </div>
    </form>
  </div>
</div>
